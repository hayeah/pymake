```toml
before = "style/py"
# select = ".go$ !test; .md !test"
# dirtree = ".go$"
commit = "unknown"
```

# User Task

Create a Python Makefile alternative.

- Execution semantics:
    - No output file: treat as `.PHONY`, always rerun
    - Output file but no input file: skip if output exists
    - Otherwise: use file timestamps to check dependencies
- The `inputs` parameter determines prerequisite tasks
- Each output file path may only be associated with one task
    - Report an error on conflict
- Detect cyclic dependencies
- Options:
    - Enable parallelism
    - Force rerun explicitly

Define tasks with the `@task` decorator:

```
@task(inputs=[file1, file2], outputs=[file3])
def build():
    compile(file1, file2, file3)
```

Running `taskpy` looks for `Makefile.py` in the current directory. Python top-level code can build inputs and outputs dynamically (e.g., using glob).

- `taskpy build` runs the `build` task if:
    - Any output file does not exist
    - Any input file is newer than an output file
    - The rerun flag is used
- `taskpy file3` finds the task that produces `file3` and runs it

The `run_if` parameter adds a custom condition. After file dependencies are satisfied, taskpy calls the function; run the task only if it returns `True`.

```
@task(in=[file1, file2], out=[file3], run_if=custom_test_func)
def build():
    compile(file1, file2, file3)
```

Use `task.register` to define tasks dynamically:

```
from pathlib import Path
from taskpy import task  # task is a registry object

def register_compile_task(src: Path):
    obj = Path("build") / (src.stem + ".o")

    def run():
        compile_one(src, obj)

    task.register(
        run,
        name=f"cc:{src.as_posix()}",
        inputs=[src],
        outputs=[obj],
    )

SRC = sorted(Path().glob("src/**/*.c"))
for s in SRC:
    register_compile_task(s)
```

CLI subcommands:

- `taskpy list` — list named tasks
- `taskpy list --all` — list named tasks, then dynamically registered tasks
- `taskpy graph [target]` — create a dot graph of tasks and files for a target
- `taskpy run [target1] [target2] ...` — run specified targets
- `taskpy help` — show help
- Fallback: if the first argument matches a target, run it

---

Let's first use Makefile to build tasks. Once we have this tool working, we can create Makefile.py for this project.